name: Flutter Semantic Release

on:
  workflow_call:
    inputs:
      target-env:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      target-env:
        description: "Environment to build for"
        required: true
        type: choice
        options:
          - production
          - staging
          - sandbox
jobs:
  release:
    runs-on: macos-latest  #Note: mac runs are not cheap. Needed for PlistBuddy (used in update_version.sh)

    steps:
      - name: ðŸ›Žï¸ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed for semantic-release to analyze full history

      - name: ðŸ§° Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: ðŸ“¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.3'
          channel: stable

      - name: â™»ï¸ Cache Flutter and Node dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
            release/node_modules
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml', '**/package.json') }}

      - name: ðŸ“¥ Install Flutter and Node dependencies
        run: |
          flutter pub get
          cd release
          npm ci

      - name: ðŸš€ Run Semantic Release
        working-directory: release
        run: npx semantic-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Force bump if build number unchanged
        continue-on-error: true
        run: |
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          BUILD_NUMBER=$(cat release/build_number.txt)
          echo "ðŸ”Ž Version in pubspec: $CURRENT_VERSION"
          echo "ðŸ”Ž Last known build number: $BUILD_NUMBER"

          # Check if current version ends in current build number
          if [[ "$CURRENT_VERSION" =~ \+$BUILD_NUMBER$ ]]; then
            echo "âœ… Build number matches"
          else
            echo "âš ï¸ Build number mismatch or not updated â€” forcing update"
            NEW_BUILD=$((BUILD_NUMBER + 1))
            echo "$NEW_BUILD" > release/build_number.txt
            bash release/scripts/update_version.sh $(echo $CURRENT_VERSION | cut -d+ -f1)

      - name: ðŸ·ï¸ Extract latest tag
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          echo "$LATEST_TAG" > version.txt
          echo "version=$LATEST_TAG" >> $GITHUB_ENV

      - name: ðŸ§¾ Extract latest changelog section
        run: awk '/^## /{if (seen) exit; seen=1} seen' CHANGELOG.md > changelog.txt

      - name: ðŸ“¤ Upload release version
        uses: actions/upload-artifact@v4
        with:
          name: flutter-release-version
          path: version.txt
